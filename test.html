<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      #imageContainer {
        position: relative;
        display: inline-block;
        border: 2px dashed #ccc;
        background-color: #f8f9fa;
        max-width: 100%;
      }

      #imagePreview {
        display: none;
        width: 100%;
        height: auto;
      }

      .draggable {
        display: none;
        position: absolute;
        cursor: grab;
        touch-action: none;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        user-select: none;
        font-family: "Sarabun", sans-serif;
      }

      .draggable:active {
        cursor: grabbing;
      }

      #signature-overlay {
        padding: 0;
        background: transparent;
        border: 1px dashed blue;
        overflow: hidden;
      }

      .resize-handle {
        position: absolute;
        width: 15px;
        height: 15px;
        right: 0;
        bottom: 0;
        background: #007bff;
        cursor: se-resize;
        z-index: 10;
      }

      #signature-pad-container {
        border: 1px solid black;
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <div class="container p-3">
      <h3>Image Signature App</h3>
      <form id="mainForm">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="fullname" class="form-label">ชื่อ นามสกุล</label>
            <input type="text" class="form-control" id="fullname" required />
          </div>
          <div class="col-md-6">
            <label for="telephone" class="form-label">เบอร์โทร</label>
            <input type="tel" class="form-control" id="telephone" required />
          </div>
        </div>

        <div class="mb-3">
          <label for="imageInput" class="form-label">เลือกรูปภาพ</label>
          <input
            class="form-control"
            type="file"
            id="imageInput"
            accept="image/*"
            required
          />
        </div>

        <p>ลากข้อความและลายเซ็นไปวางในตำแหน่งที่ต้องการ</p>
        <div id="imageContainer" class="mb-3">
          <img id="imagePreview" src="#" alt="Image Preview" />
          <div
            id="fullname-overlay"
            class="draggable"
            style="top: 20px; left: 20px"
          >
            ชื่อ นามสกุล
          </div>
          <div
            id="telephone-overlay"
            class="draggable"
            style="top: 60px; left: 20px"
          >
            0987654321
          </div>
          <div
            id="signature-overlay"
            class="draggable"
            style="top: 100px; left: 20px; width: 150px; height: 80px"
          >
            <canvas id="signatureCanvas"></canvas>
            <div class="resize-handle"></div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">วาดลายเซ็นในกรอบด้านล่างนี้</label>
          <div id="signature-pad-container">
            <canvas
              id="signaturePadElement"
              style="width: 100%; height: 200px"
            ></canvas>
          </div>
        </div>

        <button id="clearButton" type="button" class="btn btn-warning">
          ล้างลายเซ็น
        </button>
        <button type="submit" class="btn btn-success">บันทึก</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script>
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");
      const imageContainer = document.getElementById("imageContainer");
      const fullnameInput = document.getElementById("fullname");
      const telephoneInput = document.getElementById("telephone");
      const fullnameOverlay = document.getElementById("fullname-overlay");
      const telephoneOverlay = document.getElementById("telephone-overlay");
      const signatureOverlay = document.getElementById("signature-overlay");
      const overlayCanvas = document.getElementById("signatureCanvas");
      const overlayCtx = overlayCanvas.getContext("2d");

      const signaturePadCanvas = document.getElementById("signaturePadElement");
      const signaturePad = new SignaturePad(signaturePadCanvas);

      let isResizing = false;

      let croppedSignature = null;

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        signaturePadCanvas.width = signaturePadCanvas.offsetWidth * ratio;
        signaturePadCanvas.height = signaturePadCanvas.offsetHeight * ratio;
        signaturePadCanvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      signaturePad.addEventListener("endStroke", () => {
        const sourceCanvas = signaturePad.canvas;
        const ctx = sourceCanvas.getContext("2d");
        const { width, height } = sourceCanvas;

        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;

        let minX = width,
          minY = height,
          maxX = 0,
          maxY = 0;

        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const i = (y * width + x) * 4;
            const alpha = data[i + 3];
            if (alpha > 0) {
              if (x < minX) minX = x;
              if (x > maxX) maxX = x;
              if (y < minY) minY = y;
              if (y > maxY) maxY = y;
            }
          }
        }

        if (maxX <= minX || maxY <= minY) return;

        const margin = 10;
        minX = Math.max(minX - margin, 0);
        minY = Math.max(minY - margin, 0);
        maxX = Math.min(maxX + margin, width);
        maxY = Math.min(maxY + margin, height);

        const croppedWidth = maxX - minX;
        const croppedHeight = maxY - minY;

        signatureOverlay.style.width = croppedWidth + "px";
        signatureOverlay.style.height = croppedHeight + "px";

        overlayCanvas.width = croppedWidth;
        overlayCanvas.height = croppedHeight;
        overlayCtx.clearRect(0, 0, croppedWidth, croppedHeight);
        overlayCtx.drawImage(
          sourceCanvas,
          minX,
          minY,
          croppedWidth,
          croppedHeight,
          0,
          0,
          croppedWidth,
          croppedHeight
        );

        croppedSignatureImage = new Image();
        croppedSignatureImage.src = overlayCanvas.toDataURL();
      });

      document.getElementById("clearButton").addEventListener("click", () => {
        signaturePad.clear();
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      });

      fullnameInput.addEventListener("input", (e) => {
        fullnameOverlay.textContent = e.target.value || "ชื่อ นามสกุล";
      });

      telephoneInput.addEventListener("input", (e) => {
        telephoneOverlay.textContent = e.target.value || "0987654321";
      });

      let originalImage = null;
      imageInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = "block";
            imagePreview.onload = function () {
              const width = imagePreview.offsetWidth;
              const height = imagePreview.offsetHeight;
              imageContainer.style.width = width + "px";
              imageContainer.style.height = height + "px";
              document.querySelectorAll(".draggable").forEach((el) => {
                el.style.display = "block";
              });
            };
            originalImage = new Image();
            originalImage.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      function makeDraggable(elem) {
        let offsetX,
          offsetY,
          isDragging = false;

        elem.addEventListener("mousedown", startDrag);
        elem.addEventListener("touchstart", startDrag, { passive: false });

        function startDrag(e) {
          if (isResizing) return;
          e.preventDefault();
          const event = e.type === "touchstart" ? e.touches[0] : e;

          const container = imageContainer.getBoundingClientRect();
          const elemRect = elem.getBoundingClientRect();

          offsetX = event.clientX - elemRect.left;
          offsetY = event.clientY - elemRect.top;

          isDragging = true;

          document.addEventListener("mousemove", drag);
          document.addEventListener("mouseup", endDrag);
          document.addEventListener("touchmove", drag, { passive: false });
          document.addEventListener("touchend", endDrag);
        }

        function drag(e) {
          if (!isDragging || isResizing) return;
          const event = e.type === "touchmove" ? e.touches[0] : e;
          const container = imageContainer.getBoundingClientRect();

          let x = event.clientX - container.left - offsetX;
          let y = event.clientY - container.top - offsetY;

          const maxX = container.width - elem.offsetWidth;
          const maxY = container.height - elem.offsetHeight;

          x = Math.max(0, Math.min(x, maxX));
          y = Math.max(0, Math.min(y, maxY));

          elem.style.left = x + "px";
          elem.style.top = y + "px";
        }

        function endDrag() {
          isDragging = false;
          document.removeEventListener("mousemove", drag);
          document.removeEventListener("mouseup", endDrag);
          document.removeEventListener("touchmove", drag);
          document.removeEventListener("touchend", endDrag);
        }
      }

      ["fullname-overlay", "telephone-overlay", "signature-overlay"].forEach(
        (id) => makeDraggable(document.getElementById(id))
      );

      const sigHandle = signatureOverlay.querySelector(".resize-handle");
      sigHandle.addEventListener("mousedown", (e) => {
        e.preventDefault();
        e.stopPropagation();
        isResizing = true;

        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = signatureOverlay.offsetWidth;
        const startHeight = signatureOverlay.offsetHeight;

        function doDrag(e) {
          const newWidth = Math.max(50, startWidth + (e.clientX - startX));
          const newHeight = Math.max(30, startHeight + (e.clientY - startY));

          signatureOverlay.style.width = newWidth + "px";
          signatureOverlay.style.height = newHeight + "px";

          overlayCanvas.width = newWidth;
          overlayCanvas.height = newHeight;

          if (croppedSignatureImage) {
            overlayCtx.clearRect(0, 0, newWidth, newHeight);
            overlayCtx.drawImage(
              croppedSignatureImage,
              0,
              0,
              newWidth,
              newHeight
            );
          }
        }

        function stopDrag() {
          isResizing = false;
          document.removeEventListener("mousemove", doDrag);
          document.removeEventListener("mouseup", stopDrag);
        }

        document.addEventListener("mousemove", doDrag);
        document.addEventListener("mouseup", stopDrag);
      });
    </script>
  </body>
</html>
